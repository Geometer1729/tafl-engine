module Simul where

import Data.Array
import Params
import Control.Monad.Reader

type Game = Mat Float
type Dist = Vec Float

type Mat = Array (Int,Int)
type Vec = Array Int

-- this will probably comprise a good deal of the computation
-- so ideally it should get graphics card acceleration eventually.

scaleGame :: Game -> Game
scaleGame game = let
  ma = maximum game
  mi = minimum game
  scale = 1/(ma-mi)
  f x = (x-mi)*scale
    in fmap f game

lMult :: Num a => Vec a -> Mat a -> Vec a
lMult v m = let
  (_,(a,b)) = bounds m
    in listArray (0,b) [ sum [ m!(i,j)*v!j | j <- [0..a]] | i <- [0..a] ]

rMult :: Num a => Mat a -> Vec a -> Vec a
rMult m v = let
  (_,(a,b)) = bounds m
    in listArray (0,a) [ sum [ m!(i,j)*v!j | j <- [0..b]]   | i <- [0..a] ]

-- game -> optimal dist for 1,2
solveGame :: Game -> WPs (Dist,Dist)
solveGame g = do
  let g' = scaleGame g
  n <- asks mwItters
  let (_,(a,b)) = bounds g'
  foldM (flip mwStep) (listArray (0,a) (repeat 1),listArray (0,b) (repeat 1)) (replicate n g')


mwStep :: Game -> (Dist,Dist) -> WPs (Dist,Dist)
mwStep g (p1,p2) = asks epsilon >>= \ eps -> let
  ct1 = g  `rMult` p2
  ct2 = p1 `lMult` g
  b1 = bounds p1
  b2 = bounds p2
  -- playr 1 maximizes so the costs are negative for p1 and positive for p2
  p1' = normalize $ listArray b1 [ p1!i * (1-eps)**(- ct1!i) | i <- range b1 ]
  p2' = normalize $ listArray b2 [ p2!i * (1-eps)**(- ct2!i) | i <- range b2 ]
    in return (p1',p2')

-- ideally normalizing would be done somewhat less often

normalize :: Dist -> Dist
normalize v = let
  s = sum v
    in fmap (/s) v

-- test game
soccer :: Game
soccer = listArray ((0,0),(1,1)) [0,2,1,0]

soccerSol :: (Dist,Dist)
soccerSol = runReader (solveGame soccer) def

sample1 :: Game
sample1 = array ((0,0),(15,15)) [((0,0),34.0),((0,1),35.0),((0,2),31.0),((0,3),134.0),((0,4),25.0),((0,5),27.0),((0,6),72.0),((0,7),31.0),((0,8),35.0),((0,9),22.0),((0,10),30.0),((0,11),67.0),((0,12),25.0),((0,13),71.0),((0,14),27.0),((0,15),32.0),((1,0),30.0),((1,1),34.0),((1,2),38.0),((1,3),34.0),((1,4),42.0),((1,5),31.0),((1,6),33.0),((1,7),27.0),((1,8),36.0),((1,9),34.0),((1,10),64.0),((1,11),24.0),((1,12),26.0),((1,13),31.0),((1,14),34.0),((1,15),28.0),((2,0),127.0),((2,1),30.0),((2,2),69.0),((2,3),32.0),((2,4),37.0),((2,5),32.0),((2,6),36.0),((2,7),34.0),((2,8),98.0),((2,9),29.0),((2,10),24.0),((2,11),40.0),((2,12),27.0),((2,13),26.0),((2,14),72.0),((2,15),29.0),((3,0),27.0),((3,1),26.0),((3,2),38.0),((3,3),38.0),((3,4),36.0),((3,5),39.0),((3,6),34.0),((3,7),34.0),((3,8),31.0),((3,9),27.0),((3,10),30.0),((3,11),33.0),((3,12),38.0),((3,13),35.0),((3,14),33.0),((3,15),31.0),((4,0),26.0),((4,1),33.0),((4,2),29.0),((4,3),33.0),((4,4),64.0),((4,5),36.0),((4,6),28.0),((4,7),33.0),((4,8),31.0),((4,9),29.0),((4,10),25.0),((4,11),37.0),((4,12),35.0),((4,13),26.0),((4,14),146.0),((4,15),43.0),((5,0),31.0),((5,1),29.0),((5,2),30.0),((5,3),29.0),((5,4),32.0),((5,5),24.0),((5,6),26.0),((5,7),27.0),((5,8),30.0),((5,9),29.0),((5,10),35.0),((5,11),23.0),((5,12),31.0),((5,13),35.0),((5,14),32.0),((5,15),31.0),((6,0),33.0),((6,1),27.0),((6,2),27.0),((6,3),63.0),((6,4),32.0),((6,5),34.0),((6,6),35.0),((6,7),28.0),((6,8),36.0),((6,9),34.0),((6,10),32.0),((6,11),35.0),((6,12),26.0),((6,13),137.0),((6,14),34.0),((6,15),32.0),((7,0),28.0),((7,1),31.0),((7,2),29.0),((7,3),32.0),((7,4),38.0),((7,5),40.0),((7,6),33.0),((7,7),35.0),((7,8),26.0),((7,9),31.0),((7,10),34.0),((7,11),28.0),((7,12),35.0),((7,13),71.0),((7,14),33.0),((7,15),34.0),((8,0),33.0),((8,1),32.0),((8,2),39.0),((8,3),27.0),((8,4),27.0),((8,5),25.0),((8,6),30.0),((8,7),29.0),((8,8),34.0),((8,9),41.0),((8,10),37.0),((8,11),40.0),((8,12),39.0),((8,13),28.0),((8,14),26.0),((8,15),24.0),((9,0),36.0),((9,1),34.0),((9,2),27.0),((9,3),30.0),((9,4),31.0),((9,5),33.0),((9,6),26.0),((9,7),151.0),((9,8),37.0),((9,9),37.0),((9,10),30.0),((9,11),34.0),((9,12),37.0),((9,13),31.0),((9,14),29.0),((9,15),65.0),((10,0),130.0),((10,1),38.0),((10,2),35.0),((10,3),34.0),((10,4),37.0),((10,5),43.0),((10,6),31.0),((10,7),45.0),((10,8),25.0),((10,9),70.0),((10,10),30.0),((10,11),68.0),((10,12),38.0),((10,13),29.0),((10,14),28.0),((10,15),25.0),((11,0),31.0),((11,1),85.0),((11,2),27.0),((11,3),35.0),((11,4),29.0),((11,5),35.0),((11,6),28.0),((11,7),34.0),((11,8),29.0),((11,9),90.0),((11,10),70.0),((11,11),67.0),((11,12),28.0),((11,13),28.0),((11,14),32.0),((11,15),40.0),((12,0),34.0),((12,1),37.0),((12,2),33.0),((12,3),37.0),((12,4),31.0),((12,5),28.0),((12,6),33.0),((12,7),41.0),((12,8),69.0),((12,9),33.0),((12,10),28.0),((12,11),21.0),((12,12),25.0),((12,13),27.0),((12,14),30.0),((12,15),34.0),((13,0),40.0),((13,1),31.0),((13,2),33.0),((13,3),32.0),((13,4),27.0),((13,5),29.0),((13,6),30.0),((13,7),71.0),((13,8),30.0),((13,9),29.0),((13,10),38.0),((13,11),32.0),((13,12),34.0),((13,13),30.0),((13,14),30.0),((13,15),25.0),((14,0),28.0),((14,1),30.0),((14,2),37.0),((14,3),32.0),((14,4),25.0),((14,5),29.0),((14,6),34.0),((14,7),38.0),((14,8),36.0),((14,9),36.0),((14,10),35.0),((14,11),26.0),((14,12),83.0),((14,13),28.0),((14,14),37.0),((14,15),32.0),((15,0),38.0),((15,1),33.0),((15,2),29.0),((15,3),34.0),((15,4),34.0),((15,5),74.0),((15,6),31.0),((15,7),31.0),((15,8),33.0),((15,9),147.0),((15,10),39.0),((15,11),64.0),((15,12),34.0),((15,13),38.0),((15,14),28.0),((15,15),35.0)]

sample2 :: Game
sample2 = array ((0,0),(15,15)) [((0,0),11.0),((0,1),24.0),((0,2),13.0),((0,3),16.0),((0,4),22.0),((0,5),9.0),((0,6),12.0),((0,7),7.0),((0,8),12.0),((0,9),10.0),((0,10),12.0),((0,11),30.0),((0,12),8.0),((0,13),17.0),((0,14),13.0),((0,15),64.0),((1,0),21.0),((1,1),71.0),((1,2),12.0),((1,3),76.0),((1,4),38.0),((1,5),16.0),((1,6),14.0),((1,7),21.0),((1,8),25.0),((1,9),9.0),((1,10),8.0),((1,11),20.0),((1,12),59.0),((1,13),68.0),((1,14),13.0),((1,15),11.0),((2,0),12.0),((2,1),23.0),((2,2),11.0),((2,3),105.0),((2,4),8.0),((2,5),6.0),((2,6),186.0),((2,7),85.0),((2,8),80.0),((2,9),13.0),((2,10),77.0),((2,11),141.0),((2,12),8.0),((2,13),9.0),((2,14),66.0),((2,15),27.0),((3,0),10.0),((3,1),78.0),((3,2),10.0),((3,3),6.0),((3,4),106.0),((3,5),11.0),((3,6),111.0),((3,7),128.0),((3,8),68.0),((3,9),147.0),((3,10),16.0),((3,11),15.0),((3,12),87.0),((3,13),133.0),((3,14),14.0),((3,15),13.0),((4,0),15.0),((4,1),12.0),((4,2),13.0),((4,3),30.0),((4,4),49.0),((4,5),16.0),((4,6),9.0),((4,7),13.0),((4,8),33.0),((4,9),132.0),((4,10),13.0),((4,11),15.0),((4,12),18.0),((4,13),14.0),((4,14),21.0),((4,15),82.0),((5,0),15.0),((5,1),14.0),((5,2),84.0),((5,3),78.0),((5,4),14.0),((5,5),12.0),((5,6),9.0),((5,7),12.0),((5,8),13.0),((5,9),55.0),((5,10),9.0),((5,11),20.0),((5,12),46.0),((5,13),19.0),((5,14),11.0),((5,15),14.0),((6,0),19.0),((6,1),13.0),((6,2),16.0),((6,3),14.0),((6,4),14.0),((6,5),20.0),((6,6),18.0),((6,7),74.0),((6,8),11.0),((6,9),25.0),((6,10),16.0),((6,11),23.0),((6,12),16.0),((6,13),56.0),((6,14),15.0),((6,15),8.0),((7,0),14.0),((7,1),14.0),((7,2),58.0),((7,3),55.0),((7,4),40.0),((7,5),130.0),((7,6),14.0),((7,7),16.0),((7,8),6.0),((7,9),11.0),((7,10),18.0),((7,11),36.0),((7,12),15.0),((7,13),24.0),((7,14),13.0),((7,15),51.0),((8,0),39.0),((8,1),8.0),((8,2),70.0),((8,3),13.0),((8,4),109.0),((8,5),13.0),((8,6),111.0),((8,7),12.0),((8,8),28.0),((8,9),11.0),((8,10),7.0),((8,11),133.0),((8,12),168.0),((8,13),18.0),((8,14),11.0),((8,15),17.0),((9,0),12.0),((9,1),17.0),((9,2),9.0),((9,3),8.0),((9,4),7.0),((9,5),24.0),((9,6),71.0),((9,7),11.0),((9,8),49.0),((9,9),17.0),((9,10),9.0),((9,11),12.0),((9,12),34.0),((9,13),10.0),((9,14),52.0),((9,15),17.0),((10,0),11.0),((10,1),22.0),((10,2),32.0),((10,3),14.0),((10,4),16.0),((10,5),10.0),((10,6),12.0),((10,7),17.0),((10,8),13.0),((10,9),93.0),((10,10),10.0),((10,11),26.0),((10,12),92.0),((10,13),12.0),((10,14),20.0),((10,15),12.0),((11,0),13.0),((11,1),16.0),((11,2),15.0),((11,3),8.0),((11,4),6.0),((11,5),9.0),((11,6),7.0),((11,7),16.0),((11,8),15.0),((11,9),19.0),((11,10),15.0),((11,11),9.0),((11,12),12.0),((11,13),130.0),((11,14),9.0),((11,15),13.0),((12,0),11.0),((12,1),12.0),((12,2),26.0),((12,3),103.0),((12,4),15.0),((12,5),24.0),((12,6),9.0),((12,7),111.0),((12,8),13.0),((12,9),5.0),((12,10),12.0),((12,11),11.0),((12,12),11.0),((12,13),152.0),((12,14),6.0),((12,15),138.0),((13,0),77.0),((13,1),14.0),((13,2),111.0),((13,3),12.0),((13,4),35.0),((13,5),58.0),((13,6),54.0),((13,7),16.0),((13,8),16.0),((13,9),3.0),((13,10),108.0),((13,11),52.0),((13,12),134.0),((13,13),17.0),((13,14),21.0),((13,15),58.0),((14,0),9.0),((14,1),22.0),((14,2),19.0),((14,3),12.0),((14,4),135.0),((14,5),12.0),((14,6),15.0),((14,7),79.0),((14,8),31.0),((14,9),11.0),((14,10),90.0),((14,11),10.0),((14,12),14.0),((14,13),14.0),((14,14),8.0),((14,15),20.0),((15,0),15.0),((15,1),71.0),((15,2),10.0),((15,3),104.0),((15,4),12.0),((15,5),32.0),((15,6),134.0),((15,7),10.0),((15,8),38.0),((15,9),14.0),((15,10),67.0),((15,11),13.0),((15,12),104.0),((15,13),11.0),((15,14),12.0),((15,15),21.0)]
